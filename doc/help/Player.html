<html>
<head>
	<meta http-equiv="content-type" content="text/html" charset="utf-8"/>
	<title>FFmpeg player</title>
	<link rel="stylesheet" href="css-help.css" type="text/css">
</head>

<body lang="ru-RU">
<p class=title>FFmpeg Player</p>
<p>
Autor: Dmitry Ponomarev<br/>
Contact: <a href="dmfrox219@mail.ru">dmfrox219@mail.ru</a>
</p>
<p>
<a href="#id-1">Общая информация</a><br/>
<a href="#id-2">Настройка демультиплексора</a><br/>
<a href="#id-3">Настройка декодеров</a><br/>
<a href="#id-4">Настройка фильтров</a><br/>
<a href="#id-5">Управление проигрыванием</a><br/>
<a href="#id-6">Осциллограмма</a><br/>
<a href="#id-7">Video benckmark и дополнительные опции</a><br/>
<a href="#id-8">Информация о контейнере и открытых декодерах</a><br/>
<a href="#id-9">Яркость, контрастность, цветовая насыщенность</a><br/>
<a href="#id-10">Параметры рендеринга</a><br/>
<a href="#id-11">Настройка логирования</a><br/>
</p>
<a name="id-1"/>
<h1>Общая информация</h1>
Это медиапроигрыватель, позволяющий воспроизвести любой медиаконтейнер, поддерживаемый FFmpeg. При необходимости можно задать формат и опции для медиаконтейнера, выбрать GPU-декодер (<code>*_qsv</code> или <code>*_cuvid</code>), задать режим аппаратного ускорения для декодера, выбрать и настроить альтернативный декодер, задать фильтры. Отображается подробная информация о медиаконтейнере. При нажатой клавиши Alt для управления становятся доступными дополнительные горячие клавиши (эти клавиши отображаются подчеркнутыми в соответствующих надписях).
</p> 
<img src="img_p/App.png" />
<a name="id-2"/>
<h1>Настройка демультиплексора</h1>
<img src="img_p/Demux.png" />
<p>
Для начала надо установить тип медиаконтейнера. Выпадающий список <code>Source type</code> позволяет выбрать три варианта: <code>Media file</code>, <code>DirectShow device</code>, произвольный источник (обычно сетевой), задаваемый URL.
</p>
<p>
В поле <code>Path/Url</code> должен быть введен путь к медиафайлу или URL, при этом можно использовать выпадающий список ранее проигранных контейнеров или воспользоваться кнопкой <code>Browse...</code> .
</p>
<p> 
В случае <code>Media file</code> кнопка <code>Browse...</code> открывает стандартное окно выбора файла, в окне установлено четыре фильтра: видеофайлы, аудиофайлы, текстовые файлы и произвольные файлы.
</p>
<p>
В случае <code>DirectShow device</code> кнопка <code>Browse...</code> открывает окно выбора DirectShow-устройств видео- и аудиозахвата.
</p>
<p>
В случае URL кнопка <code>Browse...</code> заблокирована, за исключением включенного переключателя <code>RTP via *.sdp file</code> (см. далее). Также в случае URL можно использовать путь к файлу, но для корректной работы проигрывателя путь должен иметь префикс протокола <code>file:</code>.
</p>
<p>
Если нужно дополнительно установить формат или опции нужно использовать выпадающий список <code>Format</code>. Первый элемент этого списка (<code>Default</code>) означает автоматическое определение формата. Элементы этого списка берется из файла <code>params/player/Formats.xml</code>, каждый элемент списка представлен XML узлом. Вот пример такого узла:
</p>
<pre>
&lt;Format DisplayName="Video RAW (32 bpp, 320x240, 10 fps)" Name="rawvideo"&gt;
  &lt;Option Key="pixel_format" Value="bgra"/&gt;
  &lt;Option Key="video_size" Value="320x240"/&gt;
  &lt;Option Key="framerate" Value="10"/&gt;
&lt;/Format&gt;
</pre>
<p>
Атрибут <code>DisplayName</code> определяет строку, появляющуюся в выпадающем списке, атрибут <code>Name</code> определяет формат, подузлы определяют опции. Если формат определяется по URL, то значение <code>Name</code> может быть пустым. Опции могут относиться как к формату, так и к протоколу.
</p>
<p>
Переключатель <code>RTP via *.sdp file</code> доступен, в случае URL. Если переключатель включен, то протокол устанавливается как <code>rtp</code>, а его параметры берутся из <code>*.sdp</code> файла, путь к которому должен находится в поле <code>Path/Url</code>. Кнопка <code>Browse...</code> в этом случае вызывает стандартное окно открытия файла с фильтром <code>*.sdp</code>.
</p>
<a name="id-3"/>
<h1>Настройка декодеров</h1>
<img src="img_p/Decod.png" />
<p>
Выпадающие списки <code>Video decoder</code> и <code>Audio decoder</code> позволяют выбрать альтернативный декодер (или отключить декодирование). Первый элемент этих списков (<code>None</code>) отключает декодирование, второй (<code>Default</code>) означает выбор декодера по умолчанию, остальные берутся из файлов <code>params/player/DecodersVideo.xml</code>, и <code>params/player/DecodersAudio.xml</code>, каждый элемент списков представлен XML узлом. Формат узла аналогичный предыдущему, только атрибут <code>Name</code> определяет имя декодера и можно дополнительно использовать атрибут <code>Format</code>, который задает формат пикселей или отсчетов. Вот примет такого узла.
</p>
<pre>
&lt;Decoder DisplayName="h264 threads auto" Name="h264" Format="yuv420p"&gt;
  &lt;Option Key="threads" Value="auto"/&gt;
&lt;/Decoder&gt;
</pre>
<p>
Имеются возможности для ускорения декодирования видео.
</p>
<p>
Выпадающий список <code>GPU decoder</code> позволяет выбрать <code>*_qsv</code> или <code>*_cuvid</code> декодер. Если выбран декодер с помощью списки <code>Video decoder</code>, то выбор списка <code>GPU decoder</code> игнорируется.
</p>
<p>
Выпадающий список <code>HWaccel</code> позволяет выбрать режим аппаратного ускорения. Если выбран и успешно открыт декодер из списка <code>GPU decoder</code>, то этот режим игнорируется. Если режим аппаратного ускорения успешно применен при открытии декодера, то на информационной панели <code>Source/decoder info</code> в строке <code>decoder</code> будет отбражаться <code><i>decoder_name</i>+<i>hwaccel_name</i></code>, например: <code>h264+dxva2</code>.
</p>
<p>
Выпадающий список <code>Threads</code> позволяет установить количество потоков для режима многопоточного декодирования. При выборе <code>auto</code> оптимальное количество потоков устанавливается автоматически, основываясь на имеющихся аппаратных ресурсах. Если выбран декодер из списка <code>GPU decoder</code> или режим аппаратного ускорения из списока <code>HWaccel</code>, то заданное количество потоков игнорируется.
</p>
<a name="id-4"/>
<h1>Настройка фильтров</h1>
<p>
Имеется возможность использовать фильтры для дополнительной обработки видео- и аудиокадров.
</p>
<img src="img_p/Filter.png" />
<p>
Выпадающие списки <code>Video filters</code> и <code>Audio filters</code> позволяют установить фильтры для обработки кадров. Элементы этих списков берется из файлов <code>params/player/FiltersVideo.xml</code>, и <code>params/player/FiltersAudio.xml</code>, каждый элемент списков представлен XML узлом. Вот пример такого узла:
</p>
<pre>
&lt;Filter DisplayName="Echo"&gt;
  aecho=0.8:0.88:60:0.4
&lt;/Filter&gt;
</pre>
<p>
Фильтр задается текстом узла, атрибут <code>DisplayName</code> определяет строку, появляющуюся в выпадающем списке.
</p>
<p> 
Для фильтров есть ограничения: фильтр должен иметь один вход и один выход и медиатип входа и выхода должны совпадать. Соответственно, можно говорить о видеофильтрах и аудиофильтрах.
</p> 
<p>
Для фильтра субтитров можно использовать нестандартный синтаксис: <code>subtitles=default</code> или <code>subtitles=default:N</code>. В этом случае потоки субтитров будут браться из проигрываемого контейнера, <code>N</code> — это индекс потока субтитров (индекс среди потоков субтитров, а не всех потоков контейнера). Отметим, что использование фильтра субтитров может вызвать ощутимую задержку при загрузке контейнера.
</p>
<p>
Некоторые фильтры поддерживают использования команд для изменения параметров фильтра «на ходу». (Это всегда указано в документации на фильтр.) Для того, что бы воспользоваться этой возможностью, надо использовать атрибут <code>Command</code> со значением 1. В этом случае в процессе проигрывания справа от выпадающего списка будет активна кнопка <code>...</code>, она вызывает окно, которое позволяет изменить параметры фильтра. Это окно немодальное, поэтому управление проигрыванием не блокируется. Вот пример такого фильтра:
</p>
<pre>
&lt;Filter DisplayName="Draw box" Commands="1"&gt;
    drawbox=x=20:y=40:w=200:h=160:color=magenta:t=4
&lt;/Filter&gt;
</pre>
<p>
Вот соответствующее окно:
</p>
<img src="img_p/FiltComm.png" />
<p>
Для двух видеофильтров — <code>eq</code> и <code>drawtext</code> — реализованы специальные окна настройки параметров, в которых реализован более комфортный интерфейс. Для вызова этих окон значения атрибута <code>Command</code> должно быть 10 и 20 соответственно.
</p>
<p>
Некоторые видеофильтры для корректной работы проигрывателя требуют специальных параметров, которые надо устанавливать через дополнительные атрибуты узла.
</p>
<p>
Если видеофильтр меняет единицу времени для временных меток кадров, то надо добавить атрибут <code>Fps</code>. Для фильтра <code>fps</code> значением этого атрибута является новая частота кадров. Фильтры деинтерлейсинга, например <code>yadif</code>, обычно уменьшают единицу времени в два раза, в этом случае значение <code>Fps</code> должно быть -2. Вот примеры:
</p>
<pre>
&lt;Filter DisplayName="FPS 30" Fps="30"&gt;
  fps=fps=30
&lt;/Filter&gt;

&lt;Filter DisplayName="Deinterlace (yadif)" Fps="-2"&gt;
  yadif=mode=send_frame
&lt;/Filter&gt;
</pre>
<p>
Если видеофильтр может выдавать на один входной кадр ноль или несколько (больше одного) выходных кадров, то надо добавить атрибут <code>Seq</code> со значением 1. Если задан ненулевой <code>Fps</code>, то <code>Seq</code> устанавливать не надо.
</p>
<a name="id-5"/>
<h1>Управление проигрыванием</h1>
<img src="img_p/Player.png" />
<p>
Проигрывание начинается с нажатием кнопки-переключателя <code>Load</code> (горячая клавиша Ctrl+Enter). Если загрузка контейнера произошла успешно, то эта кнопка превращается в кнопку <code>Unload</code> и для файлов становятся доступными традиционные элементы управления проигрыванием: кнопка-переключатель <img src="img_p/btn-play_h.png"/> (Play/Pause, горячая клавиша Ctrl+P) и кнопка <img src="img_p/btn-stop_h.png"/> (Stop, горячая клавиша Ctrl+S).

</p>
<img src="img_p/Player2.png" />
<p>
В процессе проигрывания индикатор отображает текущую позицию проигрывания или текущее время.
</p>
<p>
Управление звуком осуществляется с помощью кнопки-переключателя <img src="img_p/btn-volm_h.png"/> (Mute) и ползунка уровня громкости. Можно использовать горячие клавиши: F7 — отключить/включить звук, F8 — уменьшить громкость, F9 — увеличить громкость.
</p>
<p>
Для видеофайлов на паузе доступна дополнительные операции. Кнопка <img src="img_p/btn-save_h.png"/> (горячая клавиша Ctrl+F), вызывает процедуру сохранения текущего кадра в <code>*.png</code> или <code>*.jpg</code> файле. Для видеофайлов, поддерживающих позиционирование, доступны кнопки <img src="img_p/btn-prev_h.png"/> и <img src="img_p/btn-next_h.png"/>, позволяющие перемещаться на предыдущий или следующий кадр соответственно. Для этих кнопок есть горячие клавиши: F11 и F12. Кнопка-переключатель <img src="img_p/btn-rewind_h.png"/> (горячая клавиша Ctrl+R) включает/выключает режим перемотки (вперед), при котором звук отключается и видео воспроизводится с частотой кадров, указанной в выпадающем списка левее. Для списка есть горячая клавиша Ctrl+U, которая переводит фокус на список, после чего текущий элемент списка меняется с помощью стрелок вверх/вниз. Обратим внимание на то, что реальная частота кадров может оказаться меньше, это происходит, когда декодер не справляется с воспроизведением с заданной частотой.
</p>
<p>
Если переключатель <code>Pix2Pix</code> выключен, то для видео отображаемый кадр занимает максимальную площадь в окне отображения (с сохранением пропорций). Если этот переключатель включен, то пиксель кадра отображается в пиксель дисплея, при этом, если размер кадра больше, чем размер окна отображения, активизируется скроллинг. Переключатель управляется горячей клавишей Ctrl+2.
</p>
<p>
В верхней части находится ползунок, отображающий текущую позицию проигрывания. Он не активен для сетевых источников, устройств захвата медиаданных («живых» источников) и других источников для которых нельзя определить длительность. Если контейнер поддерживает позиционирование (обычно это файлы), то этот ползунок позволяет изменять текущую позицию проигрывания.
</p>
<p>
Кнопка <code>Unload</code> (горячая клавиша Ctrl+Enter) прекращает проигрывание.
</p>
<a name="id-6"/>
<h1>Осциллограмма</h1></p>
<p>
Для аудиопотока можно отобразить осциллограмму. (Эта возможность доступна только для файлов.)
</p>
<img src="img_p/Osc.png" />
<p>
Для этого надо включить переключатель <code>Audio oscillogram</code>. Маркер отображает текущую позицию проигрывания. Для слабого сигнала можно включить визуальное усиление, для этого служит выпадающий список <code>Osc. zoom</code>. (Но это не влияет на уровень громкости.) 
</p>
<a name="id-7"/>
<h1>Video benckmark и дополнительные опции</h1>
<img src="img_p/BenchOpts.png" />
<p>
Переключатель <code>Video benckmark</code> включает специальный режим, в котором отключается аудиопоток, а видеопоток проигрывается с максимальной скоростью, игнорируя временные метки. Этот режим доступен только для файлов. После завершения проигрывания (или нажатия <code>Stop</code>) в статусной строке отображается отношение фактически затраченного времени к номинальной длительности видеопотока в процентах. Результат меньше 100% означает, что возможно воспроизведение видео в реальном масштабе времени. Дополнительно можно отключить рендеринг кадров (надо включить переключатель <code>No frame rendering</code>), в результате получим практически чистые затраты на декодирование. С помощью этого режима удобно сравнивать разные варианты ускорения декодирования видео.
</p>
<p>
Кнопка <code>X-options...</code> вызывает окно настройки некоторых специальных режимов. Эти опции не сохраняются при закрытии приложения.
</p>
<img src="img_p/ExtOptions.png" />
<p>
Переключатель <code>Stop on EOF</code>. Если включен, то для видеофайлов, поддерживающих позиционирование, автоматически выполняется команда <code>Stop</code> после окончания проигрывания файла, иначе после окончания проигрывания показывается последний видеокадр. В режиме <code>Video benckmark</code> команда <code>Stop</code> после окончания проигрывания файла выполняется всегда.
</p>
<p>
Переключатель <code>Synchronize video by audio</code>. Если включен, то время рендеринга видеокадра определяется по текущей позиции рендеринга аудио, иначе по системным часам.
</p>
<p>
Переключатель <code>Use filter graph always</code>. Если включен, то для преобразования формата кадров после декодирования всегда используется граф фильтров, иначе по возможности используется конвертер кадров.
</p>
Переключатель <code>Convert frames sequentially</code>. Если включен, то декодирование и последующая конвертация/фильтрация видеокадров выполняется в одном потоке, иначе конвертация/фильтрация выполняется в потоке видеорендеринга. При использовании видеофильтров с ненулевыми атрибутами <code>Fps</code> или <code>Seq</code>, это режим включается принудительно. При отключенном режиме (это установка по умолчанию) получается более сбалансированная нагрузка на рабочие потоки, снижается суммарное время на декодирование видеокадров, что можно увидеть, если включить режим <code>Video benckmark</code>. Аудиокадры всегда декодируются и затем конвертируются/фильтруются в одном потоке.
</p>
<p>
Переключатель <code>Swap fields</code>. Если включен, то переставляются четные и нечетные строки кадра. Это бывает нужно, если неправильно работает деинтерлейсинг.
</p>
<p>
Выпадающий список <code>Audio device</code> позволяет выбрать альтернативные устройства вывода звука.
</p>
<p>
Кнопка <code>Reset</code> устанавливает значения по умолчанию.
</p>
<a name="id-8"/>
<h1>Информация о контейнере и открытых декодерах</h1>
<p>
После загрузки в правом верхнем углу отображается информация о контейнере и открытых декодерах.
</p>
<img src="img_p/Src.png" />
<p>
Более подробную информацию можно получить в отдельном окне, которое вызывается кнопкой <code>Detailed...</code>. В этом окне отображаются формат и другие характеристики контейнера, потоки и их основные характеристики, открытые декодеры, метаданные контейнера и потоков, главы. Для метаданных и глав предполагается кодировка UTF-8. Кнопка <code>Save...</code> вызывает процедуру записи параметров в текстовой файл.
</p>
<img src="img_p/Params.png" />
<a name="id-9"/>
<h1>Яркость, контрастность, цветовая насыщенность</h1>
<p>
В правом нижнем углу находятся элементы для изменения яркости, контрастности и цветовой насыщенности видео. 
</p>
<img src="img_p/Bcs.png">
<p>
Режим активизируется переключателем <code>Enabled</code>, с помощью ползунков устанавливается соответствующее значение, кнопка <code>Reset</code> сбрасывает параметры в нейтральное значение. Для управление этими параметрами используются так называемые пиксельные шейдеры, специальные программы, реализованные на графических процессорах. Используется поддержка пиксельных шейдеров, встроенная в .NET WPF (так называемые эффекты), изменение визуальных характеристик кадра происходит непосредственно в процессе рендеринга.
</p>
<p> 
Отметим, что в FFmpeg есть видеофильтр <code>eq</code>, который решает ту же задачу, но делает он это обрабатывая кадр до рендеринга. Для этого фильтра доступно специальное окно для настройки параметров, оно позволяет изменять параметры «на ходу».
</p>
<a name="id-10"/>
<h1>Параметры рендеринга</h1>
<p>
В статусной строке в поле <code>Rend params</code> отображаются параметры рендеринга.
</p>
<img src="img_p/Rnd.png" />
<p>
Для видео это размер кадра и формат пикселей, для аудио — число каналов, частота дискретизации и формат отсчетов.
</p>
<a name="id-11"/>
<h1>Настройка логирования</h1>
<p>
Файлы логов находятся в папке <code>C:/Users/<i>user_name</i>/AppData/Local/dm_frox/FFmpegSuite/player/_LOGS</code>. Это простые текстовые файлы в кодировке UTF-8. Файл <code>CppPlayer.log</code> содержит логи модуля <code>FFmpegWrapper.dll</code> и библиотек FFmpeg. Файл <code>NetPlayer.log</code> содержит логи .NET модулей. Файлы с суффиксом <code>_XX</code> являются бэкапами. 
</p>
<p>
Можно задать максимальный уровень логирования, используемый в модуле <code>FFmpegWrapper.dll</code> и в библиотеках FFmpeg, а также дополнительные опции. Параметры логирования берутся из файлов <code>params/player/LogParams.xml</code>, который содержит единственный узел:
</p>
<pre>
&lt;LogParams wrapper="3" ffmpeg="3" options="0" /&gt;
</pre>
<p>
Атрибут <code>wrapper</code> определяет максимальный уровень логирования модуля <code>FFmpegWrapper.dll</code>, атрибут <code>ffmpeg</code> определяет максимальный уровень логирования библиотек FFmpeg, атрибут <code>options</code> задает специальные режимы логирования.
</p>
<p>
Для максимального уровня логирования можно использовать значения:<br/>
0 - None;<br/>
1 - Error;<br/>
2 - Warning;<br/>
3 - Info;<br/>
4 - Verbose;<br/>
5 - Debug;<br/>
6 - Trace.<br/>
Следут иметь в виду, что в <code>FFmpegWrapper.dll</code> не используется уровень больше 3 (Info). Если максимальный уровень логирования библиотек FFmpeg имеет значения больше 4 (Verbose), то объем выводимой информации может быть очень большим, эти значения надо использовать с осторожностью. Перед сообщениями библиотек FFmpeg выводится специальная строка: [~<i>имя_компоненты</i>].
</p>
<p>
Опции могут использовать значения:<br/>
0 - не используется;<br/>
1 - операция flush после каждой строки лога;<br/> 
2 - вывод дополнительно метки потока выполнения;<br/>
3 - объединение 1 и 2.<br/>
Использование этих флагов требует дополнительных ресурсов и оправданно только для отладки.
</p>

</body>
</html>
