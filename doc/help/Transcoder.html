<html>
<head>
	<meta http-equiv="content-type" content="text/html" charset="utf-8"/>
	<title>FFmpeg transcoder</title>
	<link rel="stylesheet" href="css-help.css" type="text/css">
</head>

<body lang="ru-RU">
<p class=title>FFmpeg Transcoder</p>
<p>
Autor: Dmitry Ponomarev<br/>
Contact: <a href="dmfrox219@mail.ru">dmfrox219@mail.ru</a>
</p>
<p>
<a href="#id-1">Общая информация</a><br/>
<a href="#id-2">Настройка демультиплексора</a><br/>
<a href="#id-3">Настройка мультиплексора</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#id-3-1">Выходной контейнер</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#id-3-2">Выходные потоки</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#id-3-3">Метаданные</a><br/>
<a href="#id-4">Транскодирование</a><br/>
<a href="#id-5">Настройка логирования</a><br/>
</p>
<a name="id-1"/>
<h1>Общая информация</h1>
Это приложение позволят извлечь пакеты из одного контейнера и записать их в другой контейнер, при необходимости произведя перекодирование и обработку с помощью фильтра. Также можно добавить метаданные, как контейнера, так и потоков.
</p>
<img src="img_t/Transcoder.png" />
<a name="id-2"/>
<h1>Настройка демультиплексора</h1>
<p>
Для начала надо установить тип медиаконтейнера. Выпадающий список <code>Source type</code> позволяет выбрать три варианта: <code>Media file</code>, <code>DirectShow device</code>, произвольный источник, задаваемый URL.
</p>
<p>
В поле <code>Path/Url</code> должен быть введен путь к медиафайлу или URL, при этом в ряде случаев можно воспользоваться кнопкой <code>Browse... </code>.
</p>
<p> 
В случае <code>Media file</code> кнопка <code>Browse...</code> открывает стандартное окно открытия файла, в окне установлено четыре фильтра: видеофайлы, аудиофайлы, текстовые файлы и произвольные файлы.
</p>
<p>
В случае <code>DirectShow device</code> кнопка <code>Browse...</code> открывает окно выбора DirectShow-устройств видео- и аудиозахвата.
</p>
<p>
В случае URL кнопка <code>Browse...</code> заблокирована.
</p>
<p>
Если нужно дополнительно установить формат или опции нужно использовать выпадающий список <code>Format</code>. Элементы этого списка берутся из файла <code>params/transcoder/FormatsSrc.xml</code>, каждый элемент списка представлен XML узлом. Вот пример такого узла:
</p>
<pre>
&lt;FormOptItem DisplayName="Video RAW (32 bpp, 320x240, 10 fps)" Name="rawvideo"&gt;
  &lt;Option Key="pixel_format" Value="bgra"/&gt;
  &lt;Option Key="video_size" Value="320x240"/&gt;
  &lt;Option Key="framerate" Value="10"/&gt;
&lt;/FormOptItem&gt;
</pre>
<p>
Атрибут <code>DisplayName</code> определяет текст, появляющийся в выпадающем списке, атрибут <code>Name</code> определяет формат, подузлы определяют опции. Если формат определяется по URL, то значение <code>Name</code> может быть пустым. Опции могут относится как к формату, так и к протоколу.
</p>
<a name="id-3"/>
<h1>Настройка мультиплексора</h1>
<a name="id-3-1"/>
<h2>Выходной контейнер</h2>
<p>
В поле Path/Url должен быть введен путь к медиафайлу или URL, при этом можно воспользоваться кнопкой <code>Browse...</code> , которая открывает стандартное окно открытия файла, в окне установлено три фильтра: видеофайлы, аудиофайлы и произвольные файлы.
</p>
<p>
Если нужно дополнительно установить формат или опции нужно использовать выпадающий список <code>Format</code>. Элементы этого списка берется из файла <code>params/transcoder/FormatsDst.xml</code>, каждый элемент списка представлен XML узлом. Формат узла такой же, как и для демультиплексора.
</p>
<a name="id-3-2"/> 
<h2>Выходные потоки</h2>
<p>
Для задания параметры кодирования потоков используются два выпадающих списка: <code>Video encoder</code> и <code>Audio encoder</code>. Если выбрать элемент списка <code>None</code>, то кодирование потока не происходит, в выходном файле этого потока не будет. Элементы списков берется из файлов <code>params/transcoder/EncodersVideo.xml</code>, и <code>params/transcoder/EncodersAudio.xml</code>, каждый элемент списков представлен XML узлом. Вот пример такого узла:
</p>
<pre>
&lt;Encoder DisplayName="H264; bitrate=5M, veryfast, GOP size=20"
    Name="libx264"
    Bitrate="5M"
    Preset="veryfast">
  &lt;Option Key="g" Value="20"/&gt;
&lt;/Encoder&gt;
</pre>
<p>
Атрибут <code>DisplayName</code> определяет текст, появляющийся в выпадающем списке. Атрибут <code>Name</code> (обязательный) определяет имя кодера. Если значение этого атрибута «c», то пакеты из входного потока просто копируются в выходной поток, перекодирования не происходит.
</p>
<p> 
Для настройки кодера можно использовать следующие атрибуты.
</p>
<p>
<code>Bitrate</code> определяет битрейт. Можно использовать суффикс <code>K</code>, <code>M</code>, <code>G</code> (1000, 1000000, 1000000000).
</p>
<p>
<code>Preset</code> определяет предустановленный набор параметров кодирования (<code>libx264</code>, <code>h264_qsv</code>, <code>h264_nvenc</code>). Возможные значения: <code>ultrafast</code>, <code>superfast</code>, <code>veryfast</code>, <code>faster</code>, <code>fast</code>, <code>medium</code>, <code>slow</code>, <code>slower</code>, <code>veryslow</code>, по умолчанию <code>medium</code>. Эти значения доступны для <code>libx264</code>, другие кодеры могут использовать не все из них. Как видно из названия, этот параметр влияет на скорость кодирования.
</p>
<p>
<code>Crf</code> определяет constant rate factor (только <code>libx264</code>). Этот параметр можно рассматривать как альтернативу <code>Bitrate</code>,он обеспечивает постоянный уровень качества изображения (уровень потерь), битрейт при этом «как получится», соответственно его ненужно задавать. Значения от 0 до 51, по умолчанию 23. Значение 0 соответствует сжатию без потерь, 51 с максимальными потерями, рабочий диапазон 18-28. При этом значение <code>Preset</code> влияет не только на скорость кодирования, но и на размер выходного файла. Более медленные значения уменьшают размер. 
</p>
<p>
Остальные параметры кодера настраиваются через опции, которые задаются с помощью подузлов
</p>
<p>
Для задания параметров кадра, передаваемому кодеру, можно использовать следующие атрибуты.
</p>
<p>
<code>PixelFormat</code> определяет формат пикселей (только видео), по умолчанию такой же, как в источнике, но может быть скорректирован кодером.
</p>
<p>
<code>Width</code> определяет ширину кадра в пикселях (только видео), по умолчанию такая же, как в источнике, но может быть изменена для коррекции SAR.
</p>
<p>
<code>Height</code> определяет высоту кадра в пикселях (только видео), по умолчанию такая же, как в источнике.
</p>
<p>
<code>Fps</code> определяет частоту кадров (только видео), по умолчанию такая же, как в источнике.
</p>
<p>
<code>SampleFormat</code> определяет формат отсчетов (только аудио), по умолчанию такой же, как в источнике, но может быть скорректирован кодером.
</p>
<p>
<code>SampleRate</code> определяет частоту дискретизации (только аудио), по умолчанию такая же, как в источнике.
</p>
<p>
<code>Channels</code> определяет количество каналов (только аудио), по умолчанию такое же, как в источнике, но может быть изменено кодером.
</p>
<p>
<code>ChannLayout</code> определяет раскладку каналов (только аудио), по умолчанию такая же, как в источнике, но может быть изменена кодером.
</p>
<p>
<code>Filter</code> определяет фильтр. Для фильтров есть ограничение: фильтр должен иметь один вход и один выход. Также в фильтре нельзя устанавливать параметры кадра, описанные выше. Фильтр можно не указывать.
</p>
<a name="id-3-3"/>
<h2>Метаданные</h2>
<p>
Метаданные для выходного контейнера задаются в трех выпадающих списках: <code>Metadata</code>, <code>Metadata video</code>, <code>Metadata audio</code>. В первом задаются метаданные для самого контейнера, в остальных для потоков. Элементы этих списков берется из файлов <code>params/transcoder/Metadata.xml</code>, <code>params/transcoder/MetadataVideo.xml</code>, <code>params/transcoder/MetadataAudio.xml</code>. Каждый элемент списков представлен XML узлом. Вот пример такого узла:
</p>
<pre>
&lt;Metadata&gt;
  &lt;Item Key="Vine" Value="Cabernet"/&gt;
  &lt;Item Key="Totem" Value="Ginger cat"/&gt;
&lt;/Metadata&gt;
</pre>
<p>
В самом списке такой элемент будет представлен строкой <code>Key=Value;...</code>.
</p>
<p>
При записи метаданных используется кодировка UTF-8.
</p>
<p>
Некоторые форматы добавляют метаданные по своей инициативе, например <code>Matroska</code> добавляет в контейнер метаданные с ключом <code>ENCODER</code>, а в потоки метаданные с ключом <code>DURATION</code>. Кроме того, при записи метаданных ключи могут быть переведены в верхний регистр.
</p>
<a name="id-4"/>
<h1>Транскодирование</h1>
<p>
Процесс транскодирования запускается кнопкой <code>Start</code>. После успешного старта в правом верхнем углу отображается информация о входном контейнере контейнере. Для файлов индикатор отображает текущую относительную позицию. Также отображается текущее время. Кнопка <code>Start</code> превращается в кнопку <code>Stop</code>, с помощью которой можно преждевременно прервать процесс.
</p>
<p>
Если в процессе транскодирования компьютер перешел в режим сна, то процесс приостанавливается и его надо продолжить вручную. После выхода из режима сна становится активной кнопка <code>Resume</code>, которую надо нажать для продолжения процесса.
</p>
<a name="id-5"/>
<h1>Настройка логирования</h1>
<p>
Файлы логов находятся в папке <code>C:/Users/<i>user_name</i>/AppData/Local/dm-frox/FFmpegSuite/transcoder/_LOGS</code>. Это простые текстовые файлы в кодировке UTF-8. Файл <code>CppTrans.log</code> содержит логи модуля <code>FFmpegWrapper.dll</code> и библиотек FFmpeg. Файл <code>NetTrans.log</code> содержит логи .NET модулей. Файлы с суффиксом <code>_XX</code> являются бэкапами. 
</p>
<p>
Можно задать максимальный уровень логирования, используемый в модуле <code>FFmpegWrapper.dll</code> и в библиотеках FFmpeg, а также дополнительные опции. Параметры логирования берутся из файлов <code>params/transcoder/LogParams.xml</code>, который содержит единственный узел:
</p>
<pre>
&lt;LogParams wrapper="3" ffmpeg="3" options="0" /&gt;
</pre>
<p>
Атрибут <code>wrapper</code> определяет максимальный уровень логирования <code>FFmpegWrapper.dll</code>, атрибут <code>ffmpeg</code> определяет максимальный уровень логирования библиотек FFmpeg, атрибут <code>options</code> задает специальные режимы логирования.
</p>
<p>
Для максимального уровня логирования можно использовать значения:<br/>
0 - None;<br/>
1 - Error;<br/>
2 - Warning;<br/>
3 - Info;<br/>
4 - Verbose;<br/>
5 - Debug;<br/>
6 - Trace.<br/>
Следут иметь в виду, что в <code>FFmpegWrapper.dll</code> не используется уровень больше 3 (Info). Если максимальный уровень логирования библиотек FFmpeg имеет значения больше 4 (Verbose), то объем выводимой информации может быть очень большим, эти значения надо использовать с осторожностью. Перед сообщениями библиотек FFmpeg выводится специальная строка: [~<i>имя_компоненты</i>].
</p>
<p>
Опции могут использовать значения:<br/>
0 - не используется;<br/>
1 - операция flush после каждой строки лога;<br/> 
2 - вывод дополнительно метки потока выполнения;<br/>
3 - объединение 1 и 2.<br/>
Использование этих флагов требует дополнительных ресурсов и оправданно только для отладки.
</p>

</body>
</html>
